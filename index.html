<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>MatchMind: –§–æ—Ç–æ–ü–∞–º—è—Ç—å ‚Äî v1.0</title>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* ... (—Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
</style>
</head>

<body>
<div class="game">
<h1>üß† MatchMind: –§–æ—Ç–æ–ü–∞–º—è—Ç—å</h1>

<div id="startScreen" class="controls-start">
  <p style="font-size:17px;color:#2e2e2e;margin:16px 0">‚úèÔ∏è –ü–æ–¥–≥–æ—Ç–æ–≤—å: –ª–∏—Å—Ç –±—É–º–∞–≥–∏ –∏ –∫–∞—Ä–∞–Ω–¥–∞—à (–∏–ª–∏ —Ä—É—á–∫—É)</p>
  <div>
    <!-- max —Ç–µ–ø–µ—Ä—å 12 -->
    <input type="number" id="count" min="0" max="12" value="4">
    <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
  </div>
  <div class="mode-buttons">
    <button data-mode="matches">–°–ø–∏—á–∫–∏</button>
    <button data-mode="figures">–§–∏–≥—É—Ä—ã</button>
    <button data-mode="numbers">–ß–∏—Å–ª–∞</button>
  </div>
  
  <div id="instructions">
    <div class="instruction">
      üß† –ó–∞–ø–æ–º–Ω–∏ –æ–±—ä–µ–∫—Ç—ã<br>
      üìù –ù–∞—Ä–∏—Å—É–π –∏—Ö –Ω–∞ –±—É–º–∞–≥–µ<br>
      üëÄ –ù–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å¬ª –∏ –æ—Ç–º–µ—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    </div>
  </div>
  
  <div class="info-section">
    <h3>‚ÑπÔ∏è –û–± –∏–≥—Ä–µ</h3>
    <p>–ù–∞—à —Ç—Ä–µ–Ω–∞–∂—ë—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –Ω–∞—É—á–Ω–æ –¥–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö —Ä–∞–±–æ—Ç—ã –º–æ–∑–≥–∞. –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–º –ø–µ—Ä–µ–Ω–æ—Å–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å —ç–∫—Ä–∞–Ω–∞ –Ω–∞ –±—É–º–∞–≥—É, –∞–∫—Ç–∏–≤–∏–∑–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é –ø–∞–º—è—Ç—å.</p>
    <p>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º: —É–∂–µ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤—ã –∑–∞–º–µ—Ç–∏—Ç–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∫ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—é.</p>
    <p>–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω—ã—Ö –∏–≥—Ä –Ω–∞ –ø–∞–º—è—Ç—å, –Ω–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –Ω–∞–¥ —Ä–∞–∑–≤–∏—Ç–∏–µ–º –≤–∞—à–∏—Ö –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π.</p>
  </div>
</div>

<div id="step1" class="instruction-step hidden">üß† –ó–∞–ø–æ–º–Ω–∏ –æ–±—ä–µ–∫—Ç—ã</div>

<div id="timer" class="timer hidden"></div>
<div id="field" class="field hidden"></div>

<div id="step2" class="instruction-step hidden">üìù –ù–∞—Ä–∏—Å—É–π –∏—Ö –Ω–∞ –±—É–º–∞–≥–µ</div>

<div style="margin-top:5px">
  <button id="showBtn" class="hidden">–ü–æ–∫–∞–∑–∞—Ç—å</button>
</div>

<div id="step3" class="instruction-step hidden">üëÄ –ù–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å¬ª –∏ –æ—Ç–º–µ—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è</div>

<button id="resetBtn" class="hidden" style="margin-top:8px">–ù–æ–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞</button>

<div id="result" class="hidden"></div>
<div id="achievement" class="hidden"></div>
</div>

<script>
const SAFE = 10;
const CLICK_TOLERANCE = /Mobi|Android/i.test(navigator.userAgent) ? 14 : 7;
const animDirs = ['from-top', 'from-bottom', 'from-left', 'from-right'];
const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22'];
const MAX_COUNT = 12; // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ

const field = document.getElementById('field');
const startBtn = document.getElementById('startBtn');
const showBtn = document.getElementById('showBtn');
const resetBtn = document.getElementById('resetBtn');
const timerEl = document.getElementById('timer');
const result = document.getElementById('result');
const achievement = document.getElementById('achievement');
const countInput = document.getElementById('count');
const modeBtns = document.querySelectorAll('.mode-buttons button');
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');

let mode = null, total = 0, selected = 0, timer, gameActive = false;

// Input validation
countInput.addEventListener('input', () => {
  let v = +countInput.value;
  let corrected = false;
  if (v > MAX_COUNT) { v = MAX_COUNT; corrected = true; }
  if (v < 0) { v = 0; corrected = true; }
  countInput.value = v;
  if (corrected) {
    countInput.classList.remove('input-warn');
    void countInput.offsetWidth;
    countInput.classList.add('input-warn');
    setTimeout(() => countInput.classList.remove('input-warn'), 350);
  }
});

// Mode selection
modeBtns.forEach(b => {
  b.onclick = () => {
    modeBtns.forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    mode = b.dataset.mode;
  };
});

// Start game
startBtn.onclick = () => {
  if (gameActive) return; // –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
  
  const countValue = +countInput.value;
  if (countValue < 1 || countValue > MAX_COUNT) {
    countInput.classList.remove('input-warn');
    void countInput.offsetWidth;
    countInput.classList.add('input-warn');
    setTimeout(() => countInput.classList.remove('input-warn'), 350);
    return;
  }
  if (!mode) {
    modeBtns.forEach(btn => {
      btn.classList.remove('warn');
      void btn.offsetWidth;
      btn.classList.add('warn');
    });
    return;
  }
  
  gameActive = true;
  total = countValue;
  document.getElementById('startScreen').classList.add('hidden');
  step1.classList.remove('hidden');
  field.classList.remove('hidden');
  timerEl.classList.remove('hidden');
  generate();
  startTimer();
};

function startTimer() {
  let t = 15;
  timerEl.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${t} —Å–µ–∫`;
  timer = setInterval(() => {
    t--;
    timerEl.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${t} —Å–µ–∫`;
    if (t <= 0) {
      clearInterval(timer);
      field.classList.add('hidden');
      timerEl.classList.add('hidden');
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
      showBtn.classList.remove('hidden');
      step3.classList.remove('hidden');
    }
  }, 1000);
}

showBtn.onclick = () => {
  step2.classList.add('hidden');
  step3.classList.add('hidden');
  resetBtn.style.marginTop = '5px';
  result.style.marginTop = '7px';
  field.classList.remove('hidden');
  field.classList.add('check');
  showBtn.classList.add('hidden');
  resetBtn.classList.remove('hidden');
  updateResult();
};

resetBtn.onclick = () => {
  field.innerHTML = '';
  field.classList.add('hidden');
  timerEl.classList.add('hidden');
  step1.classList.add('hidden');
  step2.classList.add('hidden');
  step3.classList.add('hidden');
  showBtn.classList.add('hidden');
  resetBtn.classList.add('hidden');
  result.classList.add('hidden');
  achievement.classList.add('hidden');
  
  document.getElementById('startScreen').classList.remove('hidden');
  
  mode = null;
  total = 0;
  selected = 0;
  gameActive = false;
  clearInterval(timer);
  
  modeBtns.forEach(btn => btn.classList.remove('active'));
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –∏ –∫–∞—Å–∞–Ω–∏–π
function handleFieldInteraction(e) {
  if (!field.classList.contains('check')) return;
  e.preventDefault();
  
  const fr = field.getBoundingClientRect();
  const x = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
  const y = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
  
  if (!x || !y) return;

  const relX = x - fr.left;
  const relY = y - fr.top;

  field.querySelectorAll('.object').forEach(el => {
    if (el.classList.contains('selected')) return;
    const r = el.getBoundingClientRect();
    const bx = r.left - fr.left - CLICK_TOLERANCE;
    const by = r.top - fr.top - CLICK_TOLERANCE;
    const bw = r.width + CLICK_TOLERANCE * 2;
    const bh = r.height + CLICK_TOLERANCE * 2;

    if (relX >= bx && relX <= bx + bw && relY >= by && relY <= by + bh) {
      el.classList.add('selected');
      selected++;
      updateResult();
    }
  });
}

field.addEventListener('click', handleFieldInteraction);
field.addEventListener('touchend', handleFieldInteraction);

function updateResult() {
  result.textContent = `–û—Ç–º–µ—á–µ–Ω–æ: ${selected} –∏–∑ ${total}`;
  result.classList.remove('hidden');
  updateAchievement();
}

function updateAchievement() {
  achievement.style.animation = 'none';
  void achievement.offsetWidth;
  achievement.style.animation = 'pop .35s ease';
  const r = total > 0 ? selected / total : 0;
  achievement.textContent =
    r === 1 ? 'üß†‚ú® –ò–¥–µ–∞–ª—å–Ω–æ!'
    : r >= 0.8 ? 'üß†üëç –û—Ç–ª–∏—á–Ω–æ!'
    : r >= 0.5 ? 'üß† –ù–µ–ø–ª–æ—Ö–æ'
    : '';
  achievement.classList.remove('hidden');
}

function intersects(a, b) {
  return !(
    a.left + a.width <= b.left ||
    a.left >= b.left + b.width ||
    a.top + a.height <= b.top ||
    a.top >= b.top + b.height
  );
}

function generate() {
  field.innerHTML = '';
  selected = 0;
  const padding = 10;
  const fw = field.clientWidth;
  const fh = field.clientHeight;
  let placed = [];
  const maxAttempts = 5000;
  let attempts = 0;

  while (placed.length < total && attempts < maxAttempts) {
    attempts++;
    const box = createBox();
    const x = padding + Math.random() * (fw - box.el.offsetWidth - padding * 2);
    const y = padding + Math.random() * (fh - box.el.offsetHeight - padding * 2);
    box.el.style.left = x + 'px';
    box.el.style.top = y + 'px';

    document.body.appendChild(box.el); // –≤—Ä–µ–º–µ–Ω–Ω–æ –≤ DOM –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è
    const r2 = box.el.getBoundingClientRect();
    document.body.removeChild(box.el);

    const fr = field.getBoundingClientRect();
    const inSafeZone = (
      r2.left >= fr.left + SAFE &&
      r2.top >= fr.top + SAFE &&
      r2.right <= fr.right - SAFE &&
      r2.bottom <= fr.bottom - SAFE
    );

    const overlaps = placed.some(p => intersects(r2, p));

    if (inSafeZone && !overlaps) {
      placed.push(r2);
      field.appendChild(box.el);
      box.el.classList.add(animDirs[Math.floor(Math.random() * 4)]);
      box.el.style.animationDuration = (0.4 + Math.random() * 0.6) + 's';
      box.el.style.animationDelay = placed.length * 80 + 'ms';
    }
  }

  // –ï—Å–ª–∏ –Ω–µ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Ä–∞–∑–º–µ—Å—Ç–∏–ª–∏—Å—å ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º total
  if (placed.length < total) {
    console.warn(`Only ${placed.length} of ${total} objects placed.`);
    total = placed.length;
  }
}

function createBox() {
  const el = document.createElement('div');
  el.classList.add('object');

  if (mode === 'matches') {
    el.classList.add('match');
    el.style.setProperty('--rot', `${Math.random() * 360}deg`);
  }

  if (mode === 'numbers') {
    el.classList.add('number');
    el.textContent = Math.floor(Math.random() * 10);
  }

  if (mode === 'figures') {
    el.classList.add('figure');
    const shape = ['square', 'circle', 'triangle'][Math.floor(Math.random() * 3)];
    const color = colors[Math.floor(Math.random() * colors.length)];

    if (shape === 'triangle') {
      el.classList.add('triangle');
      el.style.width = '0';
      el.style.height = '0';
      el.style.borderLeft = '30px solid transparent';
      el.style.borderRight = '30px solid transparent';
      el.style.borderBottom = '60px solid ' + color;
    } else {
      el.style.width = '60px';
      el.style.height = '60px';
      el.style.background = color;
      if (shape === 'circle') el.style.borderRadius = '50%';
    }
  }

  return { el };
}

// Telegram WebApp init
if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
  Telegram.WebApp.expand();
  Telegram.WebApp.disableVerticalSwipes();
}
</script>
</body>
</html>
